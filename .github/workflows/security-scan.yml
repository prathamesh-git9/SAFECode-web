name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install fastapi uvicorn pydantic requests openai
    
    - name: Install Semgrep
      run: |
        pip install semgrep
    
    - name: Start backend server
      run: |
        # Set environment variables
        export OPENAI_API_KEY=test-key
        export GPT_MODEL=gpt-4o-mini
        
        # Start server in background
        python simple_working_backend_with_fix.py &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 10
        
        # Store PID for cleanup
        echo $SERVER_PID > server.pid
    
    - name: Wait for server to be ready
      run: |
        # Wait for health endpoint
        for i in {1..30}; do
          if curl -f http://localhost:8002/health > /dev/null 2>&1; then
            echo "Server is ready"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 2
        done
    
    - name: Test backend functionality
      run: |
        # Test basic scan functionality
        curl -X POST http://localhost:8002/scan \
          -H "Content-Type: application/json" \
          -d '{"filename": "test.c", "code": "#include <stdio.h>\nint main() { char buffer[10]; strcpy(buffer, \"test\"); return 0; }"}' \
          -o scan_response.json
        
        # Check if scan worked
        if [ -f scan_response.json ]; then
          echo "✅ Backend scan endpoint working"
        else
          echo "❌ Backend scan endpoint failed"
          exit 1
        fi
    
    - name: Run Semgrep scan
      run: |
        # Run Semgrep on the codebase
        semgrep scan --config p/security-audit --json --output scan_results.json || true
        
        # Check for critical findings
        if [ -f scan_results.json ]; then
          CRITICAL_FINDINGS=$(jq '.results[] | select(.severity == "ERROR") | .check_id' scan_results.json | wc -l)
          HIGH_FINDINGS=$(jq '.results[] | select(.severity == "WARNING") | .check_id' scan_results.json | wc -l)
          
          echo "Critical findings: $CRITICAL_FINDINGS"
          echo "High findings: $HIGH_FINDINGS"
          
          # Fail if there are critical or high findings
          if [ "$CRITICAL_FINDINGS" -gt 0 ] || [ "$HIGH_FINDINGS" -gt 0 ]; then
            echo "❌ Found $CRITICAL_FINDINGS critical and $HIGH_FINDINGS high security findings"
            echo "Please review and fix the issues before merging"
            exit 1
          else
            echo "✅ No critical or high security findings found"
          fi
        else
          echo "No scan results found"
        fi
    
    - name: Upload scan results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: scan_results
        path: scan_results.json
    
    - name: Cleanup server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
        fi
    
    - name: Security scan summary
      run: |
        if [ -f scan_results.json ]; then
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_FINDINGS=$(jq '.results | length' scan_results.json)
          CRITICAL_FINDINGS=$(jq '.results[] | select(.severity == "ERROR") | .check_id' scan_results.json | wc -l)
          HIGH_FINDINGS=$(jq '.results[] | select(.severity == "WARNING") | .check_id' scan_results.json | wc -l)
          LOW_FINDINGS=$(jq '.results[] | select(.severity == "INFO") | .check_id' scan_results.json | wc -l)
          
          echo "- **Total Findings:** $TOTAL_FINDINGS" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical:** $CRITICAL_FINDINGS" >> $GITHUB_STEP_SUMMARY
          echo "- **High:** $HIGH_FINDINGS" >> $GITHUB_STEP_SUMMARY
          echo "- **Low:** $LOW_FINDINGS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CRITICAL_FINDINGS" -gt 0 ] || [ "$HIGH_FINDINGS" -gt 0 ]; then
            echo "❌ **Security issues found!** Please review and fix before merging." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **No critical or high security issues found.**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "No scan results available" >> $GITHUB_STEP_SUMMARY
        fi
